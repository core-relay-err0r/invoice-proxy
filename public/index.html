<!DOCTYPE html>
<html lang="ru">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta charset="UTF-8">
  <title>Создать счёт</title>
</head>
<body>
  <div class="container">
    <h1>Создать новый счёт</h1>

    <form id="invoiceForm">
      <div class="row">
        <div class="column">
          <label>От кого (from):</label>
          <input type="text" name="from" required>

          <label>Кому (to):</label>
          <input type="text" name="to" required>

          <label>Адрес доставки (ship_to, optional):</label>
          <input type="text" name="ship_to">
        </div>
        <div class="column">
          <label>Дата выставления счёта (date):</label>
          <input type="date" name="date">

          <label>Условия оплаты (payment_terms):</label>
          <input type="text" name="payment_terms">

          <label>Срок оплаты (due_date):</label>
          <input type="date" name="due_date">

          <label>Номер заказа (PO Number):</label>
          <input type="text" name="purchase_order">
        </div>
      </div>

      <h3>Товары / услуги:</h3>
      <table id="items">
        <thead>
          <tr>
            <th>Название</th>
            <th>Количество</th>
            <th>Цена за единицу</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" name="item_name_0" required></td>
            <td><input type="number" name="item_quantity_0" value="1" min="1" required></td>
            <td><input type="number" name="item_amount_0" required></td>
          </tr>
        </tbody>
      </table>
      <button type="button" onclick="addItem()">+ Добавить товар</button>

      <h3>Примечания (notes):</h3>
      <textarea name="notes" rows="4"></textarea>

      <h3>Условия и политика (terms):</h3>
      <textarea name="terms" rows="4"></textarea>

      <br><br>
      <button type="submit">Создать счёт</button>
    </form>
  </div>

  <script>
    let itemCount = 1;

    function addItem() {
      const tbody = document.querySelector('#items tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" name="item_name_${itemCount}" required></td>
        <td><input type="number" name="item_quantity_${itemCount}" value="1" min="1" required></td>
        <td><input type="number" name="item_amount_${itemCount}" required></td>
      `;
      tbody.appendChild(tr);
      itemCount++;
    }

    document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const items = [];
      for (let i = 0; i < itemCount; i++) {
        const name = formData.get(`item_name_${i}`);
        const quantity = formData.get(`item_quantity_${i}`);
        const amount = formData.get(`item_amount_${i}`);
        if (name && quantity && amount) {
          items.push({
            name,
            quantity: parseInt(quantity),
            amount: parseFloat(amount)
          });
        }
      }

      const data = {
        from: formData.get('from'),
        to: formData.get('to'),
        ship_to: formData.get('ship_to'),
        date: formData.get('date'),
        payment_terms: formData.get('payment_terms'),
        due_date: formData.get('due_date'),
        purchase_order: formData.get('purchase_order'),
        notes: formData.get('notes'),
        terms: formData.get('terms'),
        items
      };

      const response = await fetch('/create-invoice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'invoice.pdf';
        a.click();
        window.URL.revokeObjectURL(url);
      } else {
        alert('Ошибка создания счёта');
      }
    });
  </script>
</body>
</html>
